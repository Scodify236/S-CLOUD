<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-CLOUD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        @media (max-width: 640px) {
            .mobile-search {
                order: 1;
                width: 100%;
                margin-top: 0.5rem;
            }

            .header-content {
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .mobile-search, #mobile-saavn-bitrate {
                margin-top: 0.5rem;
            }

            .lofi-toggle {
                display: flex !important;
                margin-top: 0.5rem;
            }

            .search-query-container {
                display: none;
            }

            .header-container {
                max-height: 160px;
                overflow-y: auto;
            }
        }

        .search-query-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding: 8px 0;
            -webkit-overflow-scrolling: touch;
        }

        .search-query-button {
            display: inline-block;
            padding: 5px 10px;
            margin-right: 10px;
            background-color: #374151;
            color: white;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-query-button:hover {
            background-color: #4b5563;
        }

        .lofi-toggle.active {
            background-color: #3ea6ff;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <header class="fixed top-0 left-0 right-0 bg-gray-800 shadow-md z-50">
        <div class="header-container">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex flex-wrap items-center justify-between header-content">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold mr-8">S-CLOUD</h1>
                        <div class="hidden sm:flex items-center">
                            <label for="saavn-bitrate" class="mr-2 text-sm">Quality:</label>
                            <select id="saavn-bitrate" class="p-2 rounded-md text-gray-900 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="4">320 kbps</option>
                                <option value="3">160 kbps</option>
                            </select>
                        </div>
                    </div>

                    <form id="search-form" class="flex w-full sm:w-auto mobile-search">
                        <input type="text" id="saavn-search-box" placeholder="Search for songs..." class="w-full sm:w-96 p-2 rounded-l-full text-gray-900 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-r-full transition duration-300">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </form>

                    <div class="sm:hidden flex items-center mt-2 w-full justify-center">
                        <label for="mobile-saavn-bitrate" class="mr-2 text-sm">Quality:</label>
                        <select id="mobile-saavn-bitrate" class="p-2 rounded-md text-gray-900 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="4">320 kbps</option>
                            <option value="3">160 kbps</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="search-query-container custom-scrollbar">
                <button class="search-query-button ml-4">Hindi</button>
                <button class="search-query-button">English</button>
                <button class="search-query-button">Punjabi</button>
                <button class="search-query-button">Marathi</button>
                <button class="search-query-button">Rajasthani</button>
                <button class="search-query-button">Odia</button>
                <button class="search-query-button">Paradox</button>
                <button class="search-query-button">Stree 2</button>
                <button class="search-query-button">Old</button>
                <button class="search-query-button">Yo Yo Honey Singh</button>
                <button class="search-query-button">Shubh</button>
                <button class="search-query-button">Deep Jhandu</button>
                <button class="search-query-button">Arjit Singh</button>
                <button class="search-query-button">Ed sheeran</button>
                <button class="search-query-button">Parmish Verma</button>
                <button class="search-query-button">Diljit Dosanjh</button>
            </div>
        </div>
    </header>


    <main class="pt-40 pb-24 px-4">
        <div id="saavn-results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-6 custom-scrollbar">
            <!-- Search results will be dynamically inserted here -->
        </div>
        <button id="loadmore" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full transition duration-300 mx-auto block">Load More</button>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-gray-800 shadow-lg">
        <div id="progress-container" class="h-1 bg-gray-600 cursor-pointer">
            <div id="progress" class="h-full bg-blue-600 w-0"></div>
        </div>
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between footer-controls">
            <div class="flex items-center">
                <img id="player-image" src="/api/placeholder/48/48" alt="Album cover" class="w-12 h-12 rounded-lg shadow-md mr-4">
                <div>
                    <p id="player-name" class="font-semibold text-sm">Song Name</p>
                    <p id="player-album" class="text-xs text-gray-400">Album Name</p>
                </div>
            </div>

            <div class="flex items-center space-x-4 play-pause-container">
                <button id="play-pause" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 transition duration-300">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                </button>

                <div class="flex items-center">
                    <div class="lofi-toggle w-12 h-6 bg-gray-600 rounded-full flex items-center p-1 cursor-pointer transition-colors duration-300">
                        <div class="lofi-toggle-knob w-4 h-4 bg-white rounded-full transition-transform duration-300"></div>
                    </div>
                    <span class="ml-2 text-sm font-medium">Lofi</span>
                </div>

                <div class="text-xs">
                    <span id="current-time">0:00</span>
                    <span>/</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
        </div>
    </footer>

    <audio id="player" crossorigin="anonymous">
        <source id="audioSource" src="" type="audio/mp3">
    </audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
    let audioContext;
    let sourceNode;
    let reverbNode;
    let slowedReverbEnabled = false;
    let lastSearch = '';

    document.getElementById('search-form').addEventListener('submit', function(event) {
        event.preventDefault();
        SaavnSearch();
    });

    function handleSearchQueryClick(query) {
        document.querySelector("#saavn-search-box").value = query;
        SaavnSearch();
    }

    document.querySelectorAll('.search-query-button').forEach(button => {
        button.addEventListener('click', function() {
            handleSearchQueryClick(this.textContent);
        });
    });

    var results_container = document.querySelector("#saavn-results");
    var results_objects = {};
    const searchUrl = "https://jiosaavn-api-privatecvc2.vercel.app/search/songs?query=";
    var currentlyPlayingAudio = null;

    function SaavnSearch() {
        var query = document.querySelector("#saavn-search-box").value.trim();
        query = encodeURIComponent(query);

        if (query.length > 0) {
            window.location.hash = query;
            doSaavnSearch(query);
        }
    }

    var page_index = 1;
    function nextPage() {
        var query = document.querySelector("#saavn-search-box").value.trim();
        if (!query) {
            query = lastSearch;
        }
        query = encodeURIComponent(query);
        doSaavnSearch(query, 0, true);
    }

    async function doSaavnSearch(query, NotScroll, page) {
        window.location.hash = query;
        document.querySelector("#saavn-search-box").value = decodeURIComponent(query);
        if (!query) {
            return 0;
        }
        if (!page) {
            results_container.innerHTML = `<div class="loader col-span-full text-center">Searching...</div>`;
        }
        query = query + "&limit=40";
        if (page) {
            page_index = page_index + 1;
            query = query + "&page=" + page_index;
        } else {
            query = query + "&page=1";
            page_index = 1;
            results_container.innerHTML = '';
        }

        try {
            var response = await fetch(searchUrl + query);
            var json = await response.json();
            if (response.status !== 200) {
                throw new Error(json.message || 'Unknown error occurred');
            }
            var results = json.data.results;
            if (!results || results.length === 0) {
                results_container.innerHTML = "<p class='col-span-full text-center'> No results found. Try another search term. </p>";
                return;
            }
            lastSearch = decodeURI(window.location.hash.substring(1));
            displayResults(results);
        } catch (error) {
            results_container.innerHTML = `<div class="error col-span-full text-center">Error: ${error.message} <br> Check if you are connected to the internet </div>`;
            console.error(error);
        }

        if (!NotScroll) {
            document.getElementById("saavn-results").scrollIntoView({ behavior: 'smooth' });
        }
    }

    function displayResults(results) {
        let resultsHTML = '';
        for (let track of results) {
            let song_name = TextAbstract(track.name, 60);
            let album_name = TextAbstract(track.album.name, 40);
            if (track.album.name == track.name) {
                album_name = "";
            }
            let play_time = formatTime(track.duration);
            let song_id = track.id;
            let year = track.year;
            let song_image = track.image[2].link;
            let song_artist = TextAbstract(track.primaryArtists, 40);
            let bitrate = document.getElementById('saavn-bitrate');
            let bitrate_i = bitrate.options[bitrate.selectedIndex].value;
            if (track.downloadUrl) {
                let download_url = track.downloadUrl[bitrate_i]['link'];
                let quality = bitrate_i == 4 ? 320 : 160;
                results_objects[song_id] = { track: track };
                resultsHTML += `
                <div class="video-container bg-gray-800 rounded-lg overflow-hidden shadow-lg transition-transform duration-300hover:scale-105 flex flex-col h-full" data-song-id="${song_id}" data-download-url="${download_url}">
                    <div class="relative pb-[56.25%]">
                        <img src="${song_image}" alt="Album cover" class="absolute top-0 left-0 w-full h-full object-cover">
                        <span class="absolute bottom-1 right-1 bg-black bg-opacity-75 text-white text-xs px-1 rounded">${play_time}</span>
                    </div>
                    <div class="p-4 flex-grow">
                        <h3 class="font-semibold text-sm mb-1">${song_name}</h3>
                        <p class="text-gray-400 text-xs">${song_artist}</p>
                        <p class="text-gray-500 text-xs mt-1">${album_name} â€¢ ${year}</p>
                    </div>
                </div>
                `;
            }
        }
        results_container.innerHTML += resultsHTML;

        document.querySelectorAll('.video-container').forEach(container => {
            container.addEventListener('click', function(e) {
                const songId = this.dataset.songId;
                const downloadUrl = this.dataset.downloadUrl;
                PlayAudio(downloadUrl, songId);
            });
        });
    }

    function TextAbstract(text, length) {
        if (text == null) {
            return "";
        }
        if (text.length <= length) {
            return text;
        }
        text = text.substring(0, length);
        last = text.lastIndexOf(" ");
        text = text.substring(0, last);
        return text + "...";
    }

    function PlayAudio(audio_url, song_id) {
        var source = document.getElementById('audioSource');
        source.src = audio_url;
        var track = results_objects[song_id].track;
        var name = track.name;
        var album = track.album.name;
        var image = track.image[2].link;
        
        document.title = name + " - " + album;
        document.getElementById("player-name").textContent = name;
        document.getElementById("player-album").textContent = album;
        document.getElementById("player-image").src = image;

        var promise = audio.load();
        if (promise) {
            promise.catch(function(error) { 
                console.error(error);
                alert('Error loading audio. Please try again.');
            });
        }
        audio.play().catch(function(error) {
            console.error(error);
            alert('Error playing audio. Please try again.');
        });
        updatePlayPauseButton(true);

        if (slowedReverbEnabled) {
            applySlowedReverbEffect();
        } else {
            removeSlowedReverbEffect();
        }
    }

    document.getElementById('loadmore').addEventListener('click', nextPage);

    const audio = document.getElementById('player');
    const progressBar = document.getElementById('progress-container');
    const progress = document.getElementById('progress');
    const currentTimeElement = document.getElementById('current-time');
    const durationElement = document.getElementById('duration');
    const playPauseButton = document.getElementById('play-pause');
    const slowedReverbToggle = document.querySelector('.lofi-toggle');

    playPauseButton.addEventListener('click', togglePlayPause);
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', () => {
        durationElement.textContent = formatTime(audio.duration);
    });
    progressBar.addEventListener('click', seek);
    slowedReverbToggle.addEventListener('click', toggleSlowedReverb);

    function togglePlayPause() {
        if (audio.paused) {
            audio.play().catch(function(error) {
                console.error(error);
                alert('Error playing audio. Please try again.');
            });
            updatePlayPauseButton(true);
        } else {
            audio.pause();
            updatePlayPauseButton(false);
        }
    }

    function updatePlayPauseButton(isPlaying) {
        playPauseButton.innerHTML = isPlaying
            ? '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>'
            : '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>';
    }

    function updateProgress() {
        if (!isNaN(audio.duration)) {
            const progressPercent = (audio.currentTime / audio.duration) * 100;
            progress.style.width = `${progressPercent}%`;
            currentTimeElement.textContent = formatTime(audio.currentTime);
        }
    }

    function seek(e) {
        const progressWidth = this.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        audio.currentTime = (clickX / progressWidth) * duration;
    }

    function formatTime(time) {
        const minutes = Math.floor(time / 60);
        const seconds = Math.floor(time % 60);
        return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function toggleSlowedReverb() {
        slowedReverbEnabled = !slowedReverbEnabled;
        const toggle = document.querySelector('.lofi-toggle');
        const knob = document.querySelector('.lofi-toggle-knob');
        
        if (slowedReverbEnabled) {
            toggle.classList.add('active');
            knob.style.transform = 'translateX(24px)';
            applySlowedReverbEffect();
        } else {
            toggle.classList.remove('active');
            knob.style.transform = 'translateX(0)';
            removeSlowedReverbEffect();
        }
    }

    function applySlowedReverbEffect() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            sourceNode = audioContext.createMediaElementSource(audio);
        }

        if (!reverbNode) {
            reverbNode = audioContext.createConvolver();
            const impulseLength = 1 * audioContext.sampleRate;
            const impulse = audioContext.createBuffer(2, impulseLength, audioContext.sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < impulseLength; i++) {
                left[i] = right[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / impulseLength, 2);
            }
            reverbNode.buffer = impulse;
        }

        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0.6, audioContext.currentTime);

        audio.preservesPitch = false;
        audio.playbackRate = 0.8;

        sourceNode.disconnect();
        sourceNode.connect(gainNode);
        gainNode.connect(audioContext.destination);
        sourceNode.connect(reverbNode);
        reverbNode.connect(audioContext.destination);
    }

    function removeSlowedReverbEffect() {
        audio.playbackRate = 1;
        audio.preservesPitch = true;

        if (sourceNode) {
            sourceNode.disconnect();
            if (reverbNode) {
                reverbNode.disconnect();
            }
            sourceNode.connect(audioContext.destination);
        }
    }

    // Initial search on page load
    if (window.location.hash) {
        doSaavnSearch(window.location.hash.substring(1));
    } else {
        doSaavnSearch('hindi', 1);
    }

    // Handle hash change
    window.addEventListener('hashchange', () => {
        doSaavnSearch(window.location.hash.substring(1));
    });

    // Update bitrate when changed
    document.getElementById('saavn-bitrate').addEventListener('change', function () {
        doSaavnSearch(lastSearch);
    });

    // Sync mobile bitrate selector with desktop
    document.getElementById('saavn-bitrate').addEventListener('change', function() {
        document.getElementById('mobile-saavn-bitrate').value = this.value;
    });

    document.getElementById('mobile-saavn-bitrate').addEventListener('change', function() {
        document.getElementById('saavn-bitrate').value = this.value;
        doSaavnSearch(lastSearch);
    });
    </script>
</body>
</html>
