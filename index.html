<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-CLOUD</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Arial', sans-serif;
        }
        .gradient-background {
            background: linear-gradient(135deg, #2d3748, #1a202c);
        }
        .search-container {
            background-color: rgba(26, 32, 44, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .results-container {
            background-color: rgba(44, 55, 72, 0.8);
            backdrop-filter: blur(10px);
            color: #e2e8f0;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .player {
            background-color: rgba(26, 32, 44, 0.9);
            backdrop-filter: blur(10px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        .progress-bar {
            background-color: #4a5568;
            cursor: pointer;
            height: 6px;
            border-radius: 3px;
        }
        .progress {
            background-color: #4299e1;
            border-radius: 3px;
        }
        .control-button {
            background-color: #4299e1;
            transition: all 0.2s;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .control-button:hover {
            background-color: #3182ce;
            transform: scale(1.1);
        }
        .song-container {
            transition: all 0.3s;
            background-color: rgba(66, 153, 225, 0.1);
            border-radius: 15px;
            margin-bottom: 12px;
            padding: 16px;
        }
        .song-container:hover {
            background-color: rgba(66, 153, 225, 0.3);
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        .lofi-toggle {
            background-color: #4a5568;
            transition: all 0.3s;
            border-radius: 15px;
            padding: 2px;
        }
        .lofi-toggle.active {
            background-color: #4299e1;
        }
        .lofi-toggle-knob {
            background-color: #e2e8f0;
            transition: all 0.3s;
            border-radius: 50%;
        }
        header {
            background-color: rgba(26, 32, 44, 0.9);
            color: #e2e8f0;
            padding: 15px 20px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        input[type="text"], select {
            background-color: #2d3748;
            border: 2px solid #4a5568;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 10px 15px;
            transition: all 0.3s;
        }
        input[type="text"]:focus, select:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
        }
        button {
            background-color: #4299e1;
            color: #e2e8f0;
            transition: all 0.3s;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #player-name {
            color: #e2e8f0;
            font-weight: bold;
            font-size: 1.1em;
        }
        #player-album {
            color: #a0aec0;
            font-size: 0.9em;
        }
        #player-image {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            width: 64px;
            height: 64px;
            object-fit: cover;
        }
        #loadmore {
            background-color: #4299e1;
            color: #e2e8f0;
            transition: all 0.3s;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
        }
        #loadmore:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .search-container {
                padding: 15px;
            }
            #search-form {
                flex-direction: column;
            }
            #saavn-search-box {
                width: 100%;
                margin-bottom: 10px;
            }
            #saavn-bitrate {
                width: 100%;
                margin-top: 10px;
            }
            button[type="submit"] {
                width: 100%;
                margin-top: 10px;
            }
            .results-container {
                padding: 15px;
            }
            .song-container {
                padding: 12px;
            }
            .player {
                padding: 10px;
            }
            #player-image {
                width: 48px;
                height: 48px;
            }
            #player-name {
                font-size: 1em;
            }
            #player-album {
                font-size: 0.8em;
            }
            .control-button {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col gradient-background">
    <header class="p-4 flex items-center">
        <img src="logo.webp" alt="S-CLOUD Logo" class="w-8 h-8 mr-2">
        <h1 class="text-2xl font-bold">S-CLOUD</h1>
    </header>

    <main class="flex-grow p-4">
        <div class="search-container rounded-lg p-4 mb-4 shadow-lg">
            <form id="search-form" class="flex">
                <input type="text" id="saavn-search-box" placeholder="Search for songs..." class="flex-grow p-2 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-r-lg transition duration-300">Search</button>
            </form>
            <select id="saavn-bitrate" class="mt-2 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="4">320 kbps</option>
                <option value="3">160 kbps</option>
            </select>
        </div>

        <div id="saavn-results" class="results-container rounded-lg p-4 overflow-y-auto custom-scrollbar shadow-lg" style="max-height: 60vh;"></div>

        <button id="loadmore" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded transition duration-300 shadow">Load More</button>
    </main>

    <footer class="player fixed bottom-0 left-0 right-0 p-4 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <img id="player-image" src="/api/placeholder/64/64" alt="Album cover" class="w-16 h-16 rounded-full mr-4 shadow-md">
                <div>
                    <p id="player-name" class="font-semibold">Song Name</p>
                    <p id="player-album" class="text-sm text-gray-400">Album Name</p>
                </div>
            </div>
            <div class="flex-grow mx-4">
                <div class="flex justify-center items-center mb-2">
                    <button id="prev-track" class="control-button rounded-full p-2 mr-4">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M15.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 010 1.414zm-6 0a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 1.414L5.414 10l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button id="play-pause" class="control-button rounded-full p-2 mr-4">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button id="next-track" class="control-button rounded-full p-2 mr-4">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 15.707a1 1 0 001.414 0l5-5a1 1 0 000-1.414l-5-5a1 1 0 00-1.414 1.414L8.586 10 4.293 14.293a1 1 0 000 1.414zm6 0a1 1 0 001.414 0l5-5a1 1 0 000-1.414l-5-5a1 1 0 00-1.414 1.414L14.586 10l-4.293 4.293a1 1 0 000 1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="lofi-toggle w-12 h-6 rounded-full flex items-center p-1 cursor-pointer">
                        <div class="lofi-toggle-knob w-4 h-4 rounded-full"></div>
                    </div>
                    <span class="ml-2 text-sm">Lofi</span>
                </div>
                <div id="progress-container" class="progress-bar w-full h-2 rounded-full">
                    <div id="progress" class="progress h-full rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
        </div>
    </footer>

    <audio id="player" crossorigin="anonymous">
        <source id="audioSource" src="" type="audio/mp3">
    </audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web-audio-api/2.0.0/audioworklet.min.js"></script>
    <script src="assets/js/functions.js"></script>
    <script src="assets/js/saavn-search.js"></script>
    <script>
let audioContext;
let sourceNode;
let reverbNode;
let slowedReverbEnabled = false;
let currentTrackIndex = -1;
let playlist = [];

const audio = document.getElementById('player');
const progressBar = document.getElementById('progress-container');
const progress = document.getElementById('progress');
const currentTimeElement = document.getElementById('current-time');
const durationElement = document.getElementById('duration');
const slowedReverbToggle = document.querySelector('.lofi-toggle');
const playPauseButton = document.getElementById('play-pause');
const prevButton = document.getElementById('prev-track');
const nextButton = document.getElementById('next-track');

document.getElementById('search-form').addEventListener('submit', function(event) {
    event.preventDefault();
    SaavnSearch();
});

playPauseButton.addEventListener('click', togglePlayPause);
prevButton.addEventListener('click', playPreviousTrack);
nextButton.addEventListener('click', playNextTrack);

audio.addEventListener('timeupdate', updateProgress);
audio.addEventListener('loadedmetadata', () => {
    durationElement.textContent = formatTime(audio.duration);
});
audio.addEventListener('ended', () => {
    playNextTrack();
});

progressBar.addEventListener('click', seek);

slowedReverbToggle.addEventListener('click', toggleSlowedReverb);

function togglePlayPause() {
    if (audio.paused) {
        audio.play();
        updatePlayPauseButton(true);
    } else {
        audio.pause();
        updatePlayPauseButton(false);
    }
}

function updatePlayPauseButton(isPlaying) {
    playPauseButton.innerHTML = isPlaying
        ? '<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>'
        : '<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>';
}

function updateProgress() {
    const progressPercent = (audio.currentTime / audio.duration) * 100;
    progress.style.width = `${progressPercent}%`;
    currentTimeElement.textContent = formatTime(audio.currentTime);
}

function seek(e) {
    const progressWidth = this.clientWidth;
    const clickX = e.offsetX;
    const duration = audio.duration;
    audio.currentTime = (clickX / progressWidth) * duration;
}

function formatTime(time) {
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
}

function toggleSlowedReverb() {
    slowedReverbEnabled = !slowedReverbEnabled;
    const toggle = document.querySelector('.lofi-toggle');
    const knob = document.querySelector('.lofi-toggle-knob');
    
    if (slowedReverbEnabled) {
        toggle.classList.add('active');
        knob.style.transform = 'translateX(24px)';
        applySlowedReverbEffect();
    } else {
        toggle.classList.remove('active');
        knob.style.transform = 'translateX(0)';
        removeSlowedReverbEffect();
    }
}

function applySlowedReverbEffect() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        sourceNode = audioContext.createMediaElementSource(audio);
    }

    // Reverb effect
    if (!reverbNode) {
        reverbNode = audioContext.createConvolver();
        const impulseLength = 1 * audioContext.sampleRate;
        const impulse = audioContext.createBuffer(2, impulseLength, audioContext.sampleRate);
        const left = impulse.getChannelData(0);
        const right = impulse.getChannelData(1);
        for (let i = 0; i < impulseLength; i++) {
            left[i] = right[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / impulseLength, 2);
        }
        reverbNode.buffer = impulse;
    }

    const gainNode = audioContext.createGain();
    gainNode.gain.setValueAtTime(0.6, audioContext.currentTime); // Adjust this value to control the wet/dry mix

    // Slow down the audio (which also lowers the pitch)
    audio.preservesPitch = false;
    audio.playbackRate = 0.8; // Adjust this value to control the slowdown effect

    sourceNode.disconnect();
    sourceNode.connect(gainNode);
    gainNode.connect(audioContext.destination); // Dry signal
    sourceNode.connect(reverbNode);
    reverbNode.connect(audioContext.destination); // Wet signal
}

function removeSlowedReverbEffect() {
    audio.playbackRate = 1;
    audio.preservesPitch = true;

    if (sourceNode) {
        sourceNode.disconnect();
        if (reverbNode) {
            reverbNode.disconnect();
        }
        sourceNode.connect(audioContext.destination);
    }
}

function PlayAudio(audio_url, song_id) {
    var source = document.getElementById('audioSource');
    source.src = audio_url;
    var name = document.getElementById(song_id+"-n").textContent;
    var album = document.getElementById(song_id+"-a").textContent;
    var image = document.getElementById(song_id+"-i").getAttribute("src");
    
    document.title = name+" - "+album;
    document.getElementById("player-name").innerHTML = name;
    document.getElementById("player-album").innerHTML = album;
    document.getElementById("player-image").setAttribute("src",image);

    var promise = audio.load();
    if (promise) {
        promise.catch(function(error) { console.error(error); });
    }
    audio.play();
    updatePlayPauseButton(true);

    if (slowedReverbEnabled) {
        applySlowedReverbEffect();
    } else {
        removeSlowedReverbEffect();
    }

    // Update the playlist and current track index
    currentTrackIndex = playlist.findIndex(track => track.id === song_id);
    if (currentTrackIndex === -1) {
        playlist.push({id: song_id, url: audio_url, name, album, image});
        currentTrackIndex = playlist.length - 1;
    }
}

function playNextTrack() {
    if (playlist.length === 0) return;
    
    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
    const nextTrack = playlist[currentTrackIndex];
    PlayAudio(nextTrack.url, nextTrack.id);
}

function playPreviousTrack() {
    if (playlist.length === 0) return;
    
    currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
    const prevTrack = playlist[currentTrackIndex];
    PlayAudio(prevTrack.url, prevTrack.id);
}

// Modified SaavnSearch function
function SaavnSearch() {
    var query = document.getElementById("saavn-search-box").value;
    var bitrate = document.getElementById("saavn-bitrate").value;
    document.getElementById("saavn-results").innerHTML = `<div class="text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-gray-200"></div>
        <p class="mt-2">Searching...</p>
    </div>`;
    
    fetch("/saavn?query=" + query)
        .then(response => response.json())
        .then(data => {
            var results = "";
            playlist = []; // Reset playlist
            data.results.forEach((song, index) => {
                results += `<div class="song-container cursor-pointer" onclick="PlayAudio('${song.media_url}', 'song-${index}')">
                    <img id="song-${index}-i" src="${song.image}" alt="${song.song}" class="w-16 h-16 rounded-full float-left mr-4">
                    <h3 id="song-${index}-n" class="font-bold">${song.song}</h3>
                    <p id="song-${index}-a" class="text-sm text-gray-400">${song.album}</p>
                    <p class="text-sm text-gray-400">${song.year}</p>
                </div>`;
                playlist.push({id: `song-${index}`, url: song.media_url, name: song.song, album: song.album, image: song.image});
            });
            document.getElementById("saavn-results").innerHTML = results;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById("saavn-results").innerHTML = `<p class="text-red-500">An error occurred while searching. Please try again.</p>`;
        });
}
</script>
</body>
</html>
